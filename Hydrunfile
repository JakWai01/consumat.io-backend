#!/bin/bash

# Install native dependencies
apt update
apt install -y build-essential python3 python3-dev python3-pip

# Fix certificate authorities on armv7
export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt

# Install dependencies
pip3 install -r requirements.txt

# Make release
if [ "$1" = 'binary' ]; then
    # Install native development dependencies
    apt install -y patchelf

    # Install python development dependencies
    pip3 install pyinstaller
    pip3 install staticx

    # Create dynamically-linked binary
    pyinstaller --onefile ./consumatio/external/api.py

    # Copy dynamically-linked binary to a new directory in the container to prevent cross-device hardlinking errors
    mkdir -p /tmp/consumatio-static-binary
    cp ./dist/api /tmp/consumatio-static-binary/consumatio-backend.dynamic

    # Create statically-linked binary
    staticx /tmp/consumatio-static-binary/consumatio-backend.dynamic /tmp/consumatio-static-binary/consumatio-backend.static

    # Stage binaries
    mkdir -p out
    cp /tmp/consumatio-static-binary/consumatio-backend.dynamic out/consumatio-backend.dynamic.linux-$(uname -m)
    cp /tmp/consumatio-static-binary/consumatio-backend.static out/consumatio-backend.linux-$(uname -m)
fi
